<!DOCTYPE html>
<html>
<head>
  <title>Ninja Bucks Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    .button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      margin-right: 5px;
    }
    .refresh-button {
      background-color: #ec8218;
      color: white;
    }
    .add-button {
      background-color: #2196F3;
      color: white;
    }
    .delete-button {
      background-color: #f44336;
      color: white;
    }
    .edit-button, .change-name-button {
      background-color: #2196F3;
      color: white;
    }
    .edit-button:hover, .change-name-button:hover {
      background-color: #1976D2;
    }
    .delete-button:hover {
      background-color: #d32f2f;
    }
    h1 {
      margin-top: 80px;
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      background: linear-gradient(45deg, #49a09d, #5f2c82);
      font-family: sans-serif;
      font-weight: 100;
    }
    .container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 800px;
    }
    .top-buttons {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .top-buttons input {
      margin-left: 10px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 15px;
      background-color: rgba(255,255,255,0.2);
      color: #fff;
    }
    th {
      text-align: left;
    }
    thead th {
      background-color: #55608f;
    }
    th {
      cursor: pointer;
    }
    tbody tr:hover {
      background-color: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button class="button refresh-button" id="refreshButton">Refresh</button>
      <button class="button add-button" id="addUserButton">Add New User</button>
      <input type="text" id="searchInput" placeholder="Search user by name">
    </div>
    <table id="userTable">
      <thead>
        <tr>
          <th id="nameHeader">Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- User data will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAVzupHsbrrYf5U__FpJ9ykyGS79-6DpMY",
      authDomain: "ninja-bucks-tracker.firebaseapp.com",
      databaseURL: "https://ninja-bucks-tracker-default-rtdb.firebaseio.com/",
      projectId: "ninja-bucks-tracker",
      storageBucket: "ninja-bucks-tracker.appspot.com",
      messagingSenderId: "249181600697",
      appId: "1:249181600697:web:cb14fff0833673451d1468"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Reference to the database
    var database = firebase.database();
    var usersRef = database.ref('users');

    // Function to update the table with user data
    function updateTable(sortBy = 'name', sortOrder = 'asc', searchQuery = '') {
      usersRef.once('value', function(snapshot) {
        var data = snapshot.val();
        var tableBody = document.querySelector('#userTable tbody');
        tableBody.innerHTML = ''; // Clear existing table rows

        // Convert data to an array
        var usersArray = Object.keys(data).map(function(userName) {
          return { name: userName, points: data[userName].points || 0 };
        });

        // Filter users based on search query
        if (searchQuery) {
          usersArray = usersArray.filter(function(user) {
            return user.name.toLowerCase().includes(searchQuery.toLowerCase());
          });
        }

        // Sort the array based on the column and order
        usersArray.sort(function(a, b) {
          if (sortBy === 'name') {
            return sortOrder === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
          } else {
            return sortOrder === 'asc' ? a.points - b.points : b.points - a.points;
          }
        });

        usersArray.forEach(function(user) {
          var row = document.createElement('tr');
          var nameCell = document.createElement('td');
          var pointsCell = document.createElement('td');
          var actionsCell = document.createElement('td');
          
          nameCell.textContent = user.name;
          pointsCell.textContent = user.points;

          var deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete';
          deleteButton.className = 'button delete-button';
          deleteButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this user?')) {
              usersRef.child(user.name).remove().then(function() {
                alert('User deleted successfully.');
                updateTable(); // Refresh the table
              }).catch(function(error) {
                console.error('Error deleting user:', error);
              });
            }
          });

          var editButton = document.createElement('button');
          editButton.textContent = 'Edit Points';
          editButton.className = 'button edit-button';
          editButton.addEventListener('click', function() {
            var newPoints = prompt('Enter new points value:', '');
            if (newPoints !== null && newPoints !== '') {
              usersRef.child(user.name).update({ points: Number(newPoints) })
                .then(function() {
                  alert('Points updated successfully.');
                  updateTable(); // Refresh the table
                }).catch(function(error) {
                  console.error('Error updating points:', error);
                });
            }
          });

          var changeNameButton = document.createElement('button');
          changeNameButton.textContent = 'Change Name';
          changeNameButton.className = 'button change-name-button';
          changeNameButton.addEventListener('click', function() {
            var newName = prompt('Enter new name:', user.name);
            if (newName !== null && newName !== '' && newName !== user.name) {
              usersRef.child(user.name).once('value').then(function(snapshot) {
                var userData = snapshot.val();
                if (userData) {
                  usersRef.child(user.name).remove().then(function() {
                    usersRef.child(newName).set(userData).then(function() {
                      alert('User name changed successfully.');
                      updateTable(); // Refresh the table
                    }).catch(function(error) {
                      console.error('Error adding new user:', error);
                    });
                  }).catch(function(error) {
                    console.error('Error removing old user:', error);
                  });
                }
              }).catch(function(error) {
                console.error('Error retrieving user data:', error);
              });
            }
          });

          actionsCell.appendChild(editButton);
          actionsCell.appendChild(changeNameButton);
          actionsCell.appendChild(deleteButton);

          row.appendChild(nameCell);
          row.appendChild(pointsCell);
          row.appendChild(actionsCell);
          tableBody.appendChild(row);
        });
      });
    }

    // Function to add a new user
    function addUser() {
      var newName = prompt('Enter new user name:');
      if (newName !== null && newName.trim() !== '') {
        usersRef.child(newName).once('value').then(function(snapshot) {
          if (snapshot.exists()) {
            alert('User name already exists. Please choose a different name.');
          } else {
            var newPoints = prompt('Enter points for the new user:');
            if (newPoints !== null && newPoints.trim() !== '') {
              usersRef.child(newName).set({ points: Number(newPoints) })
                .then(function() {
                  alert('New user added successfully.');
                  updateTable(); // Refresh the table
                }).catch(function(error) {
                  console.error('Error adding new user:', error);
                });
            }
          }
        }).catch(function(error) {
          console.error('Error checking user name:', error);
        });
      }
    }

    // Initial table update
    updateTable('name', 'asc');

    document.getElementById('refreshButton').addEventListener('click', function() {
      updateTable(); // Refresh table data
    });

    document.getElementById('addUserButton').addEventListener('click', addUser);

    document.getElementById('searchInput').addEventListener('input', function() {
      var searchQuery = this.value;
      updateTable('name', 'asc', searchQuery);
    });

    document.getElementById('nameHeader').addEventListener('click', function() {
      const currentSortOrder = this.getAttribute('data-sort') || 'asc';
      const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      updateTable('name', newSortOrder);
      this.setAttribute('data-sort', newSortOrder);
    });

    document.getElementById('pointsHeader').addEventListener('click', function() {
      const currentSortOrder = this.getAttribute('data-sort') || 'asc';
      const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      updateTable('points', newSortOrder);
      this.setAttribute('data-sort', newSortOrder);
    });
  </script>
</body>
</html>
